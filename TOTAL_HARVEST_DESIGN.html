<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Total Harvest/Catch Estimator - Design Document • tidycreel</title><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Total Harvest/Catch Estimator - Design Document"></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">tidycreel</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="articles/effort_survey_first.html">Effort (Survey-First)</a></li>
    <li><a class="dropdown-item" href="articles/aerial.html">Aerial Effort</a></li>
    <li><a class="dropdown-item" href="articles/survey_creel_terms.html">Survey Terms → Creel Translator</a></li>
    <li><a class="dropdown-item" href="articles/replicate_designs_creel.html">Replicate Designs for Creel</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><a class="external-link nav-link" href="https://github.com/chrischizinski/tidycreel/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Total Harvest/Catch Estimator - Design Document</h1>
      <small class="dont-index">Source: <a href="https://github.com/chrischizinski/tidycreel/blob/main/TOTAL_HARVEST_DESIGN.md" class="external-link"><code>TOTAL_HARVEST_DESIGN.md</code></a></small>
    </div>

<div id="total-harvestcatch-estimator---design-document" class="section level1">

<p><strong>Function:</strong> <code>est_total_harvest()</code> <strong>Status:</strong> Design phase <strong>Priority:</strong> P0 - Critical blocking function</p>
<hr><div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<p>Estimates total harvest, catch, or releases by multiplying effort estimates with CPUE estimates, properly propagating variance using the delta method. Supports both general population estimates and target species-specific estimates (caught while sought).</p>
<hr></div>
<div class="section level2">
<h2 id="function-signatures">Function Signatures<a class="anchor" aria-label="anchor" href="#function-signatures"></a></h2>
<div class="section level3">
<h3 id="primary-function">Primary Function<a class="anchor" aria-label="anchor" href="#primary-function"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,                    <span class="co"># Tibble from est_effort()</span></span>
<span>  <span class="va">cpue_est</span>,                      <span class="co"># Tibble from est_cpue()</span></span>
<span>  by <span class="op">=</span> <span class="cn">NULL</span>,                     <span class="co"># Grouping variables (must match)</span></span>
<span>  response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"catch_total"</span>, <span class="st">"catch_kept"</span>, <span class="st">"catch_released"</span><span class="op">)</span>,</span>
<span>  species_groups <span class="op">=</span> <span class="cn">NULL</span>,         <span class="co"># Named list for species aggregation</span></span>
<span>  aggregate_level <span class="op">=</span> <span class="st">"species"</span>,   <span class="co"># "species", "group", "all"</span></span>
<span>  method <span class="op">=</span> <span class="st">"product"</span>,            <span class="co"># "product", "separate_ratio"</span></span>
<span>  correlation <span class="op">=</span> <span class="cn">NULL</span>,            <span class="co"># Optional: correlation between E and CPUE</span></span>
<span>  conf_level <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  diagnostics <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Returns:</strong> Standard tidycreel tibble</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  [grouping_vars],</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  estimate,        <span class="co"># Total harvest/catch/release</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  se,              <span class="co"># Standard error</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>  ci_low,          <span class="co"># Lower confidence limit</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>  ci_high,         <span class="co"># Upper confidence limit</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>  n,               <span class="co"># Sample size</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  method,          <span class="co"># "product" or "separate_ratio"</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  diagnostics      <span class="co"># List-column with details</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>)</span></code></pre></div>
<hr></div>
<div class="section level3">
<h3 id="variant-caught-while-sought-target-species">Variant: Caught While Sought (Target Species)<a class="anchor" aria-label="anchor" href="#variant-caught-while-sought-target-species"></a></h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest_sought</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,                    <span class="co"># Total effort (all anglers)</span></span>
<span>  <span class="va">cpue_est_targeted</span>,             <span class="co"># CPUE from anglers targeting this species</span></span>
<span>  <span class="va">target_proportion</span>,             <span class="co"># Proportion of effort targeting species</span></span>
<span>  by <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  response <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"catch_total"</span>, <span class="st">"catch_kept"</span>, <span class="st">"catch_released"</span><span class="op">)</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"product"</span>,</span>
<span>  conf_level <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  diagnostics <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Alternative approach:</strong> Build this into main function via parameters</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  by <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_total"</span>,</span>
<span>  target_species_only <span class="op">=</span> <span class="cn">FALSE</span>,   <span class="co"># If TRUE, filter to targeted effort</span></span>
<span>  target_species_col <span class="op">=</span> <span class="st">"target_species"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"product"</span>,</span>
<span>  correlation <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  conf_level <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  diagnostics <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="response-types">Response Types<a class="anchor" aria-label="anchor" href="#response-types"></a></h2>
<div class="section level3">
<h3 id="id_1-catch_total-total-catch">1. <code>"catch_total"</code> (Total Catch)<a class="anchor" aria-label="anchor" href="#id_1-catch_total-total-catch"></a></h3>
<p>All fish caught, including kept and released. - <strong>Numerator:</strong> Total catch from interviews - <strong>CPUE:</strong> Catch per unit effort (fish/hour) - <strong>Result:</strong> Total catch = Effort × CPUE_total</p>
</div>
<div class="section level3">
<h3 id="id_2-catch_kept-total-harvest">2. <code>"catch_kept"</code> (Total Harvest)<a class="anchor" aria-label="anchor" href="#id_2-catch_kept-total-harvest"></a></h3>
<p>Fish kept/harvested only. - <strong>Numerator:</strong> Kept fish from interviews - <strong>CPUE:</strong> Harvest per unit effort (kept fish/hour) - <strong>Result:</strong> Total harvest = Effort × CPUE_kept</p>
</div>
<div class="section level3">
<h3 id="id_3-catch_released-total-released">3. <code>"catch_released"</code> (Total Released)<a class="anchor" aria-label="anchor" href="#id_3-catch_released-total-released"></a></h3>
<p>Fish caught and released. - <strong>Numerator:</strong> Released fish from interviews - <strong>CPUE:</strong> Release rate (released fish/hour) - <strong>Result:</strong> Total released = Effort × CPUE_released</p>
<p><strong>Relationship Check:</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Should hold approximately:</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>catch_total ≈ catch_kept <span class="sc">+</span> catch_released</span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="species-aggregation-framework">Species Aggregation Framework<a class="anchor" aria-label="anchor" href="#species-aggregation-framework"></a></h2>
<div class="section level3">
<h3 id="overview-1">Overview<a class="anchor" aria-label="anchor" href="#overview-1"></a></h3>
<p>Creel surveys require flexible species aggregation to support multiple reporting levels: 1. <strong>Individual Species:</strong> Species-specific estimates (e.g., largemouth bass, smallmouth bass) 2. <strong>Species Groups:</strong> Taxonomic or management groups (e.g., black bass, panfish, catfish) 3. <strong>All Species Combined:</strong> Total fishery harvest across all species</p>
<p><strong>Key Principle:</strong> Aggregation must occur at the CPUE level BEFORE multiplying by effort, using survey-design-based aggregation to properly account for sampling variance.</p>
</div>
<div class="section level3">
<h3 id="aggregation-levels">Aggregation Levels<a class="anchor" aria-label="anchor" href="#aggregation-levels"></a></h3>
<div class="section level4">
<h4 id="level-1-individual-species-default">Level 1: Individual Species (Default)<a class="anchor" aria-label="anchor" href="#level-1-individual-species-default"></a></h4>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_est</span>, by <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span></span></code></pre></div>
<p>Returns estimates for each species separately:</p>
<pre><code>species          estimate    se
largemouth_bass      1500   200
smallmouth_bass       800   120
bluegill             600    90</code></pre>
</div>
<div class="section level4">
<h4 id="level-2-species-groups">Level 2: Species Groups<a class="anchor" aria-label="anchor" href="#level-2-species-groups"></a></h4>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  black_bass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"largemouth_bass"</span>, <span class="st">"smallmouth_bass"</span>, <span class="st">"spotted_bass"</span><span class="op">)</span>,</span>
<span>  panfish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bluegill"</span>, <span class="st">"redear_sunfish"</span>, <span class="st">"green_sunfish"</span>, <span class="st">"pumpkinseed"</span><span class="op">)</span>,</span>
<span>  catfish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"channel_catfish"</span>, <span class="st">"flathead_catfish"</span>, <span class="st">"blue_catfish"</span><span class="op">)</span>,</span>
<span>  centrarchids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black_bass"</span>, <span class="st">"panfish"</span><span class="op">)</span>  <span class="co"># Can reference other groups</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  species_groups <span class="op">=</span> <span class="va">species_groups</span>,</span>
<span>  aggregate_level <span class="op">=</span> <span class="st">"group"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Returns estimates for each group:</p>
<pre><code>species_group  estimate    se
black_bass         2300   235
panfish            1800   180
catfish             900   130</code></pre>
</div>
<div class="section level4">
<h4 id="level-3-all-species-combined">Level 3: All Species Combined<a class="anchor" aria-label="anchor" href="#level-3-all-species-combined"></a></h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  aggregate_level <span class="op">=</span> <span class="st">"all"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Returns single estimate across all species:</p>
<pre><code>estimate    se
    5000   350</code></pre>
</div>
</div>
<div class="section level3">
<h3 id="statistical-approach-survey-based-aggregation">Statistical Approach: Survey-Based Aggregation<a class="anchor" aria-label="anchor" href="#statistical-approach-survey-based-aggregation"></a></h3>
<p><strong>CRITICAL:</strong> Must aggregate CPUE estimates using survey design, NOT simple addition of harvest estimates.</p>
<p><strong>Correct Approach:</strong> 1. Aggregate CPUE at species group level using <code><a href="https://rdrr.io/pkg/survey/man/svyby.html" class="external-link">survey::svyby()</a></code> or <code><a href="https://rdrr.io/pkg/survey/man/surveysummary.html" class="external-link">survey::svytotal()</a></code> 2. Multiply aggregated CPUE by effort 3. Propagate variance using delta method</p>
<p><strong>Incorrect Approach (DO NOT DO):</strong></p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># WRONG - Don't add harvest estimates directly</span></span>
<span><span class="va">harvest_bass_total</span> <span class="op">&lt;-</span> <span class="va">harvest_largemouth</span><span class="op">$</span><span class="va">estimate</span> <span class="op">+</span> <span class="va">harvest_smallmouth</span><span class="op">$</span><span class="va">estimate</span></span></code></pre></div>
<p>This ignores covariance between species and produces incorrect variance estimates.</p>
</div>
<div class="section level3">
<h3 id="implementation-strategy">Implementation Strategy<a class="anchor" aria-label="anchor" href="#implementation-strategy"></a></h3>
<div class="section level4">
<h4 id="option-a-pre-aggregate-cpue-recommended">Option A: Pre-aggregate CPUE (Recommended)<a class="anchor" aria-label="anchor" href="#option-a-pre-aggregate-cpue-recommended"></a></h4>
<p>User aggregates CPUE before calling <code>est_total_harvest()</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 1. Calculate species-level CPUE</span></span>
<span><span class="va">cpue_by_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, by <span class="op">=</span> <span class="st">"species"</span>, response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Aggregate CPUE to groups using survey design</span></span>
<span><span class="co"># Helper function needed: aggregate_cpue()</span></span>
<span><span class="va">cpue_black_bass</span> <span class="op">&lt;-</span> <span class="fu">aggregate_cpue</span><span class="op">(</span></span>
<span>  cpue_data <span class="op">=</span> <span class="va">interviews</span>,  <span class="co"># Raw interview data</span></span>
<span>  svy_design <span class="op">=</span> <span class="va">svy_int</span>,</span>
<span>  species_col <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  species_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"largemouth_bass"</span>, <span class="st">"smallmouth_bass"</span><span class="op">)</span>,</span>
<span>  group_name <span class="op">=</span> <span class="st">"black_bass"</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_kept"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Calculate total harvest for group</span></span>
<span><span class="va">harvest_black_bass</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_black_bass</span><span class="op">)</span></span></code></pre></div>
<p><strong>Advantage:</strong> Clear two-step process, explicit about survey-based aggregation <strong>Disadvantage:</strong> Requires helper function <code>aggregate_cpue()</code></p>
</div>
<div class="section level4">
<h4 id="option-b-integrated-aggregation-user-friendly">Option B: Integrated Aggregation (User-Friendly)<a class="anchor" aria-label="anchor" href="#option-b-integrated-aggregation-user-friendly"></a></h4>
<p><code>est_total_harvest()</code> handles aggregation internally:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  black_bass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"largemouth_bass"</span>, <span class="st">"smallmouth_bass"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">harvest_by_group</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  species_groups <span class="op">=</span> <span class="va">species_groups</span>,</span>
<span>  aggregate_level <span class="op">=</span> <span class="st">"group"</span>,</span>
<span>  cpue_data <span class="op">=</span> <span class="va">interviews</span>,   <span class="co"># Need raw data for aggregation</span></span>
<span>  svy_design <span class="op">=</span> <span class="va">svy_int</span>      <span class="co"># Need survey design</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Advantage:</strong> One-step process, user-friendly <strong>Disadvantage:</strong> Function becomes more complex, requires raw data + design</p>
<p><strong>RECOMMENDATION:</strong> Start with Option A (separate aggregation), add Option B if demand exists.</p>
</div>
</div>
<div class="section level3">
<h3 id="helper-function-aggregate_cpue">Helper Function: <code>aggregate_cpue()</code>
<a class="anchor" aria-label="anchor" href="#helper-function-aggregate_cpue"></a></h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Aggregate CPUE Across Species Using Survey Design</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Combines CPUE estimates for multiple species into a single aggregate,</span></span>
<span><span class="co">#' properly accounting for survey design and covariance between species.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param cpue_data Interview data (raw, before estimation)</span></span>
<span><span class="co">#' @param svy_design Survey design object (svydesign/svrepdesign)</span></span>
<span><span class="co">#' @param species_col Column name containing species</span></span>
<span><span class="co">#' @param species_values Character vector of species to aggregate</span></span>
<span><span class="co">#' @param group_name Name for the aggregated group</span></span>
<span><span class="co">#' @param by Additional grouping variables (e.g., location, date)</span></span>
<span><span class="co">#' @param response Type of catch ("catch_total", "catch_kept", "catch_released")</span></span>
<span><span class="co">#' @param effort_col Effort column (default "hours_fished")</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Tibble with aggregated CPUE estimates (same schema as est_cpue)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @details</span></span>
<span><span class="co">#' Uses survey package to properly aggregate species:</span></span>
<span><span class="co">#' 1. Filters to specified species</span></span>
<span><span class="co">#' 2. Sums catch across species within each interview</span></span>
<span><span class="co">#' 3. Estimates aggregate CPUE using survey design</span></span>
<span><span class="co">#' 4. Returns in standard tidycreel format</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' \dontrun{</span></span>
<span><span class="co">#' # Aggregate largemouth and smallmouth bass</span></span>
<span><span class="co">#' cpue_black_bass &lt;- aggregate_cpue(</span></span>
<span><span class="co">#'   cpue_data = interviews,</span></span>
<span><span class="co">#'   svy_design = svy_int,</span></span>
<span><span class="co">#'   species_col = "species",</span></span>
<span><span class="co">#'   species_values = c("largemouth_bass", "smallmouth_bass"),</span></span>
<span><span class="co">#'   group_name = "black_bass",</span></span>
<span><span class="co">#'   response = "catch_kept"</span></span>
<span><span class="co">#' )</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' # Use in total harvest calculation</span></span>
<span><span class="co">#' harvest_black_bass &lt;- est_total_harvest(effort_est, cpue_black_bass)</span></span>
<span><span class="co">#' }</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">aggregate_cpue</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">cpue_data</span>,</span>
<span>  <span class="va">svy_design</span>,</span>
<span>  <span class="va">species_col</span> <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  <span class="va">species_values</span>,</span>
<span>  <span class="va">group_name</span>,</span>
<span>  <span class="va">by</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">response</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"catch_total"</span>, <span class="st">"catch_kept"</span>, <span class="st">"catch_released"</span><span class="op">)</span>,</span>
<span>  <span class="va">effort_col</span> <span class="op">=</span> <span class="st">"hours_fished"</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Implementation:</span></span>
<span>  <span class="co"># 1. Validate inputs</span></span>
<span>  <span class="co"># 2. Create aggregated catch variable</span></span>
<span>  <span class="co"># 3. Update survey design with aggregated data</span></span>
<span>  <span class="co"># 4. Call est_cpue() on aggregated design</span></span>
<span>  <span class="co"># 5. Add group_name to results</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="species-group-definitions">Species Group Definitions<a class="anchor" aria-label="anchor" href="#species-group-definitions"></a></h3>
<p>Common groupings in fisheries management:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Standard taxonomic groups</span></span>
<span><span class="va">standard_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Sunfish family (Centrarchidae)</span></span>
<span>  black_bass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"largemouth_bass"</span>, <span class="st">"smallmouth_bass"</span>, <span class="st">"spotted_bass"</span>,</span>
<span>                 <span class="st">"guadalupe_bass"</span>, <span class="st">"shoal_bass"</span><span class="op">)</span>,</span>
<span>  panfish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bluegill"</span>, <span class="st">"redear_sunfish"</span>, <span class="st">"green_sunfish"</span>,</span>
<span>              <span class="st">"pumpkinseed"</span>, <span class="st">"longear_sunfish"</span>, <span class="st">"warmouth"</span>,</span>
<span>              <span class="st">"white_crappie"</span>, <span class="st">"black_crappie"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Catfish (Ictaluridae)</span></span>
<span>  catfish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"channel_catfish"</span>, <span class="st">"flathead_catfish"</span>, <span class="st">"blue_catfish"</span>,</span>
<span>              <span class="st">"bullhead_spp"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Temperate bass (Moronidae)</span></span>
<span>  temperate_bass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"white_bass"</span>, <span class="st">"striped_bass"</span>, <span class="st">"hybrid_striped_bass"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Pike family (Esocidae)</span></span>
<span>  pike <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"northern_pike"</span>, <span class="st">"muskellunge"</span>, <span class="st">"tiger_muskie"</span>, <span class="st">"chain_pickerel"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Walleye/Sauger (Percidae - predators)</span></span>
<span>  walleye_sauger <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"walleye"</span>, <span class="st">"sauger"</span>, <span class="st">"saugeye"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Trout/Salmon (Salmonidae)</span></span>
<span>  trout <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rainbow_trout"</span>, <span class="st">"brown_trout"</span>, <span class="st">"brook_trout"</span>, <span class="st">"lake_trout"</span>,</span>
<span>            <span class="st">"cutthroat_trout"</span><span class="op">)</span>,</span>
<span>  salmon <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"chinook_salmon"</span>, <span class="st">"coho_salmon"</span>, <span class="st">"sockeye_salmon"</span>,</span>
<span>             <span class="st">"pink_salmon"</span>, <span class="st">"chum_salmon"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># All centrarchids (sunfish family)</span></span>
<span>  centrarchids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black_bass"</span>, <span class="st">"panfish"</span><span class="op">)</span>  <span class="co"># References other groups</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Management-based groups</span></span>
<span><span class="va">management_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  gamefish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black_bass"</span>, <span class="st">"pike"</span>, <span class="st">"walleye_sauger"</span>, <span class="st">"trout"</span>, <span class="st">"salmon"</span><span class="op">)</span>,</span>
<span>  sportfish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gamefish"</span>, <span class="st">"catfish"</span>, <span class="st">"temperate_bass"</span><span class="op">)</span>,</span>
<span>  nongame <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"carp"</span>, <span class="st">"gar"</span>, <span class="st">"bowfin"</span>, <span class="st">"buffalo"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="hierarchical-aggregation">Hierarchical Aggregation<a class="anchor" aria-label="anchor" href="#hierarchical-aggregation"></a></h3>
<p>Support nested groupings (groups containing other groups):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="co"># Base groups (species level)</span></span>
<span>  black_bass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"largemouth_bass"</span>, <span class="st">"smallmouth_bass"</span><span class="op">)</span>,</span>
<span>  panfish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bluegill"</span>, <span class="st">"redear_sunfish"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Meta-groups (group level)</span></span>
<span>  centrarchids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black_bass"</span>, <span class="st">"panfish"</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="co"># Top level (all gamefish)</span></span>
<span>  gamefish <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"centrarchids"</span>, <span class="st">"pike"</span>, <span class="st">"walleye"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Resolution Algorithm:</strong> 1. Expand group references recursively 2. Detect circular references (error) 3. Aggregate from bottom up (species → groups → meta-groups)</p>
</div>
<div class="section level3">
<h3 id="multiple-stratification-levels">Multiple Stratification Levels<a class="anchor" aria-label="anchor" href="#multiple-stratification-levels"></a></h3>
<p>Support estimation at multiple strata simultaneously:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># By location and species group</span></span>
<span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_by_location</span>,           <span class="co"># Effort stratified by location</span></span>
<span>  <span class="va">cpue_by_location_species</span>,     <span class="co"># CPUE by location × species</span></span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location"</span>, <span class="st">"species"</span><span class="op">)</span>,</span>
<span>  species_groups <span class="op">=</span> <span class="va">standard_groups</span>,</span>
<span>  aggregate_level <span class="op">=</span> <span class="st">"group"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Returns:</p>
<pre><code>location  species_group  estimate    se
North     black_bass         1500   200
North     panfish             800   120
South     black_bass         2000   250
South     panfish            1200   150</code></pre>
</div>
<div class="section level3">
<h3 id="special-cases">Special Cases<a class="anchor" aria-label="anchor" href="#special-cases"></a></h3>
<div class="section level4">
<h4 id="id_1-mixed-aggregation-levels">1. Mixed Aggregation Levels<a class="anchor" aria-label="anchor" href="#id_1-mixed-aggregation-levels"></a></h4>
<p>User wants some species individually and some as groups:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Want: largemouth (individual), other bass (grouped), panfish (grouped)</span></span>
<span><span class="va">cpue_largemouth</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, filter_species <span class="op">=</span> <span class="st">"largemouth_bass"</span><span class="op">)</span></span>
<span><span class="va">cpue_other_bass</span> <span class="op">&lt;-</span> <span class="fu">aggregate_cpue</span><span class="op">(</span></span>
<span>  <span class="va">svy_int</span>, species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"smallmouth_bass"</span>, <span class="st">"spotted_bass"</span><span class="op">)</span>,</span>
<span>  group_name <span class="op">=</span> <span class="st">"other_bass"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">cpue_panfish</span> <span class="op">&lt;-</span> <span class="fu">aggregate_cpue</span><span class="op">(</span></span>
<span>  <span class="va">svy_int</span>, species <span class="op">=</span> <span class="va">panfish_species</span>, group_name <span class="op">=</span> <span class="st">"panfish"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine for reporting</span></span>
<span><span class="va">harvest_detailed</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span></span>
<span>  <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_largemouth</span><span class="op">)</span>,</span>
<span>  <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_other_bass</span><span class="op">)</span>,</span>
<span>  <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_panfish</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="id_2-all-species-combined">2. All Species Combined<a class="anchor" aria-label="anchor" href="#id_2-all-species-combined"></a></h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Aggregate CPUE across ALL species</span></span>
<span><span class="va">cpue_all</span> <span class="op">&lt;-</span> <span class="fu">aggregate_cpue</span><span class="op">(</span></span>
<span>  cpue_data <span class="op">=</span> <span class="va">interviews</span>,</span>
<span>  svy_design <span class="op">=</span> <span class="va">svy_int</span>,</span>
<span>  species_col <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  species_values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">interviews</span><span class="op">$</span><span class="va">species</span><span class="op">)</span>,  <span class="co"># All species</span></span>
<span>  group_name <span class="op">=</span> <span class="st">"all_species"</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_kept"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">harvest_total</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_all</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="id_3-conditional-grouping">3. Conditional Grouping<a class="anchor" aria-label="anchor" href="#id_3-conditional-grouping"></a></h4>
<p>Group by species only in certain locations:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Black bass grouped in reservoirs, separate in rivers</span></span>
<span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"waterbody_type"</span>, <span class="st">"species"</span><span class="op">)</span>,</span>
<span>  species_groups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    black_bass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"largemouth_bass"</span>, <span class="st">"smallmouth_bass"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  aggregate_condition <span class="op">=</span> <span class="va">waterbody_type</span> <span class="op">==</span> <span class="st">"reservoir"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="validation--error-handling">Validation &amp; Error Handling<a class="anchor" aria-label="anchor" href="#validation--error-handling"></a></h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check for species not in data</span></span>
<span><span class="va">validate_species_groups</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">species_groups</span>, <span class="va">cpue_data</span>, <span class="va">species_col</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">all_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">cpue_data</span><span class="op">[[</span><span class="va">species_col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">group_name</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">species_groups</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">group_species</span> <span class="op">&lt;-</span> <span class="va">species_groups</span><span class="op">[[</span><span class="va">group_name</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">missing</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">group_species</span>, <span class="va">all_species</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">missing</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_warn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>        <span class="st">"!"</span> <span class="op">=</span> <span class="st">"Species group {.field {group_name}} includes species not in data."</span>,</span>
<span>        <span class="st">"i"</span> <span class="op">=</span> <span class="st">"Missing species: {.val {missing}}"</span>,</span>
<span>        <span class="st">"&gt;"</span> <span class="op">=</span> <span class="st">"These will be ignored in aggregation."</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Detect circular references</span></span>
<span><span class="va">detect_circular_refs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">species_groups</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Graph-based cycle detection</span></span>
<span>  <span class="co"># Error if circular reference found</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="performance-considerations">Performance Considerations<a class="anchor" aria-label="anchor" href="#performance-considerations"></a></h3>
<ul><li>
<strong>Survey aggregation is computationally intensive</strong> for large datasets</li>
<li>Cache intermediate aggregations when doing multiple harvest calculations</li>
<li>Consider parallel processing for multiple groups</li>
<li>Document computational complexity in vignettes</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="statistical-methods">Statistical Methods<a class="anchor" aria-label="anchor" href="#statistical-methods"></a></h2>
<div class="section level3">
<h3 id="method-1-product-estimator-default">Method 1: Product Estimator (Default)<a class="anchor" aria-label="anchor" href="#method-1-product-estimator-default"></a></h3>
<p><strong>Estimate:</strong></p>
<pre><code>H = E × C</code></pre>
<p>Where: - <code>H</code> = Total harvest - <code>E</code> = Total effort (angler-hours) - <code>C</code> = CPUE (catch per angler-hour)</p>
<p><strong>Variance (Delta Method):</strong></p>
<p>When E and C are <strong>independent</strong> (from different surveys):</p>
<pre><code>Var(H) = E² × Var(C) + C² × Var(E)</code></pre>
<p>When E and C are <strong>correlated</strong> (from same survey):</p>
<pre><code>Var(H) = E² × Var(C) + C² × Var(E) + 2 × E × C × Cov(E,C)</code></pre>
<p><strong>Standard Error:</strong></p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/pkg/survey/man/SE.html" class="external-link">SE</a></span><span class="op">(</span><span class="va">H</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu">Var</span><span class="op">(</span><span class="va">H</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p><strong>Confidence Interval (Wald):</strong></p>
<pre><code>CI = H ± z_(α/2) × SE(H)</code></pre>
<hr></div>
<div class="section level3">
<h3 id="method-2-separate-ratio-estimator">Method 2: Separate Ratio Estimator<a class="anchor" aria-label="anchor" href="#method-2-separate-ratio-estimator"></a></h3>
<p>Alternative approach treating this as a ratio estimation problem.</p>
<p><strong>Estimate:</strong></p>
<pre><code>H = (Σw_i × catch_i) / (Σw_i × effort_i) × E_total</code></pre>
<p>Where we use survey weights to estimate the ratio, then multiply by total effort.</p>
<p><strong>Variance:</strong> Use Taylor linearization or replicate weights from the survey design.</p>
<hr></div>
<div class="section level3">
<h3 id="correlation-between-effort-and-cpue">Correlation Between Effort and CPUE<a class="anchor" aria-label="anchor" href="#correlation-between-effort-and-cpue"></a></h3>
<p><strong>When are they correlated?</strong> - When CPUE is calculated from interviews that also contribute to effort estimates - When both estimates use same survey design/weights</p>
<p><strong>When are they independent?</strong> - Effort from count data, CPUE from separate interview data - Different survey designs/time periods</p>
<p><strong>Estimating Correlation:</strong> If not provided by user, can estimate from data when both from same survey:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If both estimates are from same source data</span></span>
<span><span class="va">cor_est</span> <span class="op">&lt;-</span> <span class="fu">estimate_correlation</span><span class="op">(</span><span class="va">effort_data</span>, <span class="va">cpue_data</span><span class="op">)</span></span></code></pre></div>
<p>Default behavior: - If <code>correlation = NULL</code>, assume independent (conservative) - If <code>correlation = "auto"</code>, attempt to estimate from data - If <code>correlation = numeric</code>, use provided value</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="target-species-caught-while-sought">Target Species (“Caught While Sought”)<a class="anchor" aria-label="anchor" href="#target-species-caught-while-sought"></a></h2>
<div class="section level3">
<h3 id="conceptual-framework">Conceptual Framework<a class="anchor" aria-label="anchor" href="#conceptual-framework"></a></h3>
<p><strong>Total Catch of Species S:</strong></p>
<pre><code>Total_S = Effort_all × CPUE_S_targeted × Prop_targeted +
          Effort_all × CPUE_S_incidental × (1 - Prop_targeted)</code></pre>
<p>Simplified when incidental catch is negligible:</p>
<pre><code>Total_S_sought = Effort_targeted_S × CPUE_S_targeted</code></pre>
<p>Where: - <code>Effort_targeted_S</code> = Effort by anglers targeting species S - <code>CPUE_S_targeted</code> = CPUE of species S among those targeting it</p>
</div>
<div class="section level3">
<h3 id="implementation-options">Implementation Options<a class="anchor" aria-label="anchor" href="#implementation-options"></a></h3>
<div class="section level4">
<h4 id="option-a-separate-function-cleaner">Option A: Separate Function (Cleaner)<a class="anchor" aria-label="anchor" href="#option-a-separate-function-cleaner"></a></h4>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest_sought</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,                    <span class="co"># Total effort</span></span>
<span>  <span class="va">cpue_est_targeted</span>,             <span class="co"># CPUE from targeted anglers</span></span>
<span>  <span class="va">target_proportion</span>,             <span class="co"># Proportion targeting</span></span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"location"</span><span class="op">)</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_kept"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="option-b-integrated-function-more-flexible">Option B: Integrated Function (More flexible)<a class="anchor" aria-label="anchor" href="#option-b-integrated-function-more-flexible"></a></h4>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"location"</span><span class="op">)</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_kept"</span>,</span>
<span>  target_species_only <span class="op">=</span> <span class="cn">TRUE</span>,    <span class="co"># NEW parameter</span></span>
<span>  target_col <span class="op">=</span> <span class="st">"target_species"</span>  <span class="co"># Column identifying target</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>Recommendation:</strong> Start with Option B (integrated) for flexibility.</p>
<hr></div>
</div>
</div>
<div class="section level2">
<h2 id="data-requirements">Data Requirements<a class="anchor" aria-label="anchor" href="#data-requirements"></a></h2>
<div class="section level3">
<h3 id="input-effort_est">Input: effort_est<a class="anchor" aria-label="anchor" href="#input-effort_est"></a></h3>
<p>Tibble from <code><a href="reference/est_effort.html">est_effort()</a></code> with required columns:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="sc">-</span> [grouping_vars] <span class="sc">:</span> character<span class="sc">/</span><span class="fu">factor</span> (e.g., date, location)</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="sc">-</span> estimate        <span class="sc">:</span> <span class="fu">numeric</span> (angler<span class="sc">-</span>hours)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="sc">-</span> se              <span class="sc">:</span> <span class="fu">numeric</span> (standard error)</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="sc">-</span> ci_low          <span class="sc">:</span> numeric</span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a><span class="sc">-</span> ci_high         <span class="sc">:</span> numeric</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a><span class="sc">-</span> n               <span class="sc">:</span> integer</span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="sc">-</span> method          <span class="sc">:</span> character</span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a><span class="sc">-</span> diagnostics     <span class="sc">:</span> list</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="input-cpue_est">Input: cpue_est<a class="anchor" aria-label="anchor" href="#input-cpue_est"></a></h3>
<p>Tibble from <code><a href="reference/est_cpue.html">est_cpue()</a></code> with required columns:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="sc">-</span> [grouping_vars] <span class="sc">:</span> character<span class="sc">/</span><span class="fu">factor</span> (must match effort_est)</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="sc">-</span> estimate        <span class="sc">:</span> <span class="fu">numeric</span> (catch per hour)</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="sc">-</span> se              <span class="sc">:</span> <span class="fu">numeric</span> (standard error)</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a><span class="sc">-</span> ci_low          <span class="sc">:</span> numeric</span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a><span class="sc">-</span> ci_high         <span class="sc">:</span> numeric</span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a><span class="sc">-</span> n               <span class="sc">:</span> integer</span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a><span class="sc">-</span> method          <span class="sc">:</span> character</span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a><span class="sc">-</span> diagnostics     <span class="sc">:</span> list</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="validation">Validation<a class="anchor" aria-label="anchor" href="#validation"></a></h3>
<p>Function must check: 1. ✅ Grouping variables match between inputs 2. ✅ No missing values in estimate/se columns 3. ✅ Positive values for estimates and SE 4. ✅ Same number of groups in both inputs 5. ⚠️ Warn if methods differ (e.g., instantaneous effort with ratio-of-means CPUE) 6. ⚠️ Warn if sample sizes differ substantially</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="implementation-plan">Implementation Plan<a class="anchor" aria-label="anchor" href="#implementation-plan"></a></h2>
<div class="section level3">
<h3 id="phase-1-core-product-estimator-week-1">Phase 1: Core Product Estimator (Week 1)<a class="anchor" aria-label="anchor" href="#phase-1-core-product-estimator-week-1"></a></h3>
<p><strong>File:</strong> <code>R/est-total-harvest.R</code></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Total Harvest/Catch Estimator (survey-first)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Estimates total harvest, catch, or releases by multiplying effort and CPUE</span></span>
<span><span class="co">#' estimates with proper variance propagation using the delta method.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param effort_est Tibble from \code{\link{est_effort}} with effort estimates</span></span>
<span><span class="co">#' @param cpue_est Tibble from \code{\link{est_cpue}} with CPUE estimates</span></span>
<span><span class="co">#' @param by Character vector of grouping variables (must match between inputs)</span></span>
<span><span class="co">#' @param response Type of catch: "catch_total", "catch_kept", "catch_released"</span></span>
<span><span class="co">#' @param method Estimation method: "product" (default) or "separate_ratio"</span></span>
<span><span class="co">#' @param correlation Correlation between effort and CPUE. NULL (independent),</span></span>
<span><span class="co">#'   "auto" (estimate from data), or numeric value between -1 and 1.</span></span>
<span><span class="co">#' @param conf_level Confidence level for Wald CIs (default 0.95)</span></span>
<span><span class="co">#' @param diagnostics Include diagnostic information (default TRUE)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return Tibble with grouping columns, estimate, se, ci_low, ci_high, n,</span></span>
<span><span class="co">#'   method, and diagnostics list-column</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @details</span></span>
<span><span class="co">#' Combines effort and CPUE estimates to calculate total harvest/catch:</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' \deqn{H = E \times C}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' where \eqn{E} is total effort (angler-hours) and \eqn{C} is CPUE.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' **Variance Propagation (Delta Method):**</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' When effort and CPUE are independent:</span></span>
<span><span class="co">#' \deqn{Var(H) = E^2 \times Var(C) + C^2 \times Var(E)}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' When correlated (e.g., from same survey):</span></span>
<span><span class="co">#' \deqn{Var(H) = E^2 \times Var(C) + C^2 \times Var(E) + 2EC \times Cov(E,C)}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @examples</span></span>
<span><span class="co">#' \dontrun{</span></span>
<span><span class="co">#' # Complete workflow</span></span>
<span><span class="co">#' library(tidycreel)</span></span>
<span><span class="co">#' library(survey)</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' # 1. Estimate effort from counts</span></span>
<span><span class="co">#' svy_day &lt;- as_day_svydesign(calendar, day_id = "date",</span></span>
<span><span class="co">#'                              strata_vars = c("day_type"))</span></span>
<span><span class="co">#' effort_est &lt;- est_effort(svy_day, counts, method = "instantaneous",</span></span>
<span><span class="co">#'                          by = c("location"))</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' # 2. Estimate CPUE from interviews</span></span>
<span><span class="co">#' svy_int &lt;- svydesign(ids = ~1, weights = ~1, data = interviews)</span></span>
<span><span class="co">#' cpue_est &lt;- est_cpue(svy_int, by = c("location", "species"),</span></span>
<span><span class="co">#'                      response = "catch_kept")</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' # 3. Calculate total harvest</span></span>
<span><span class="co">#' harvest_total &lt;- est_total_harvest(</span></span>
<span><span class="co">#'   effort_est,</span></span>
<span><span class="co">#'   cpue_est,</span></span>
<span><span class="co">#'   by = c("location", "species"),</span></span>
<span><span class="co">#'   response = "catch_kept",</span></span>
<span><span class="co">#'   method = "product"</span></span>
<span><span class="co">#' )</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' # 4. Total catch and releases</span></span>
<span><span class="co">#' catch_total &lt;- est_total_harvest(effort_est, cpue_total,</span></span>
<span><span class="co">#'                                  response = "catch_total")</span></span>
<span><span class="co">#' releases &lt;- est_total_harvest(effort_est, cpue_released,</span></span>
<span><span class="co">#'                               response = "catch_released")</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' # 5. Verify relationship</span></span>
<span><span class="co">#' catch_total$estimate ≈ harvest_total$estimate + releases$estimate</span></span>
<span><span class="co">#' }</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @references</span></span>
<span><span class="co">#' Seber, G.A.F. 1982. The Estimation of Animal Abundance. 2nd edition.</span></span>
<span><span class="co">#'   Charles Griffin, London.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Pollock, K.H., C.M. Jones, and T.L. Brown. 1994. Angler Survey Methods</span></span>
<span><span class="co">#'   and Their Applications in Fisheries Management. American Fisheries</span></span>
<span><span class="co">#'   Society Special Publication 25.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @seealso</span></span>
<span><span class="co">#' \code{\link{est_effort}}, \code{\link{est_cpue}}, \code{\link{est_catch}}</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">est_total_harvest</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  <span class="va">by</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">response</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"catch_total"</span>, <span class="st">"catch_kept"</span>, <span class="st">"catch_released"</span><span class="op">)</span>,</span>
<span>  <span class="va">method</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"product"</span>, <span class="st">"separate_ratio"</span><span class="op">)</span>,</span>
<span>  <span class="va">correlation</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">conf_level</span> <span class="op">=</span> <span class="fl">0.95</span>,</span>
<span>  <span class="va">diagnostics</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Implementation here</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="phase-2-target-species-variant-week-2">Phase 2: Target Species Variant (Week 2)<a class="anchor" aria-label="anchor" href="#phase-2-target-species-variant-week-2"></a></h3>
<p>Add parameters to main function:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">...</span>,</span>
<span>  target_species_only <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  target_col <span class="op">=</span> <span class="st">"target_species"</span>,</span>
<span>  target_value <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Or separate function:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest_sought</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="phase-3-testing-week-2-3">Phase 3: Testing (Week 2-3)<a class="anchor" aria-label="anchor" href="#phase-3-testing-week-2-3"></a></h3>
<p><strong>Test File:</strong> <code>tests/testthat/test-est-total-harvest.R</code></p>
<p>Test cases: 1. Basic product estimator with known values 2. Grouped estimates (by species, location) 3. Variance propagation validation 4. Correlation handling (independent, correlated) 5. Different response types (total, kept, released) 6. Edge cases (zero effort, zero CPUE, single group) 7. Input validation (mismatched groups, missing columns) 8. Target species filtering 9. Integration with actual survey data</p>
</div>
<div class="section level3">
<h3 id="phase-4-documentation-week-3">Phase 4: Documentation (Week 3)<a class="anchor" aria-label="anchor" href="#phase-4-documentation-week-3"></a></h3>
<p><strong>Vignette:</strong> <code>vignettes/complete-creel-workflow.Rmd</code></p>
<p>Sections: 1. Introduction - Complete creel analysis workflow 2. Survey Design - Creating day-level and interview designs 3. Effort Estimation - From count data 4. CPUE Estimation - From interview data 5. Total Harvest Calculation - <strong>NEW</strong> - Total catch, harvest, and releases - Variance propagation - Interpretation 6. Target Species Analysis - <strong>NEW</strong> - Caught while sought - Species-specific effort 7. Visualization - Time series, comparisons 8. Reporting - Tables and figures</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="api-design-decisions">API Design Decisions<a class="anchor" aria-label="anchor" href="#api-design-decisions"></a></h2>
<div class="section level3">
<h3 id="decision-1-single-function-vs-multiple-functions">Decision 1: Single Function vs Multiple Functions<a class="anchor" aria-label="anchor" href="#decision-1-single-function-vs-multiple-functions"></a></h3>
<p><strong>Option A: Single comprehensive function</strong></p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_est</span>, <span class="va">...</span>, target_species_only <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>✅ Pros: Flexible, fewer functions to document ❌ Cons: More complex parameter handling</p>
<p><strong>Option B: Separate functions</strong></p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_est</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="fu">est_total_harvest_sought</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_est</span>, <span class="va">target_col</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>✅ Pros: Clearer intent, simpler parameters ❌ Cons: More functions, potential code duplication</p>
<p><strong>DECISION:</strong> Start with Option A, add Option B if needed.</p>
<hr></div>
<div class="section level3">
<h3 id="decision-2-correlation-handling">Decision 2: Correlation Handling<a class="anchor" aria-label="anchor" href="#decision-2-correlation-handling"></a></h3>
<p><strong>Option A: User provides correlation</strong></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">correlation</span> <span class="op">=</span> <span class="fl">0.3</span>  <span class="co"># User must know/estimate</span></span></code></pre></div>
<p>✅ Pros: Explicit, user control ❌ Cons: Requires user knowledge</p>
<p><strong>Option B: Auto-estimate when possible</strong></p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">correlation</span> <span class="op">=</span> <span class="st">"auto"</span>  <span class="co"># Function attempts to estimate</span></span></code></pre></div>
<p>✅ Pros: Convenient, less user burden ❌ Cons: May be incorrect if data structure unclear</p>
<p><strong>Option C: Always assume independent (default)</strong></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">correlation</span> <span class="op">=</span> <span class="cn">NULL</span>  <span class="co"># Conservative assumption</span></span></code></pre></div>
<p>✅ Pros: Safe default, wider CIs ❌ Cons: May be overly conservative</p>
<p><strong>DECISION:</strong> Support all three, default to Option C (NULL = independent).</p>
<hr></div>
<div class="section level3">
<h3 id="decision-3-response-type-consistency">Decision 3: Response Type Consistency<a class="anchor" aria-label="anchor" href="#decision-3-response-type-consistency"></a></h3>
<p>Match existing pattern from <code><a href="reference/est_cpue.html">est_cpue()</a></code> and <code><a href="reference/est_catch.html">est_catch()</a></code>:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"catch_total"</span>, <span class="st">"catch_kept"</span>, <span class="st">"weight_total"</span><span class="op">)</span></span></code></pre></div>
<p><strong>ADD:</strong> <code>"catch_released"</code></p>
<p><strong>DECISION:</strong> - Keep existing response types - Add <code>"catch_released"</code> - Document relationship: <code>catch_total = catch_kept + catch_released</code></p>
<hr></div>
</div>
<div class="section level2">
<h2 id="diagnostics-output">Diagnostics Output<a class="anchor" aria-label="anchor" href="#diagnostics-output"></a></h2>
<p>The <code>diagnostics</code> list-column should include:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  effort_method <span class="op">=</span> <span class="st">"instantaneous"</span>,           <span class="co"># From effort estimate</span></span>
<span>  cpue_method <span class="op">=</span> <span class="st">"ratio_of_means"</span>,           <span class="co"># From CPUE estimate</span></span>
<span>  correlation_assumed <span class="op">=</span> <span class="fl">0</span>,                   <span class="co"># Correlation used</span></span>
<span>  correlation_source <span class="op">=</span> <span class="st">"user"</span>,               <span class="co"># "user", "auto", "independent"</span></span>
<span>  effort_n <span class="op">=</span> <span class="fl">45</span>,                            <span class="co"># Sample size from effort</span></span>
<span>  cpue_n <span class="op">=</span> <span class="fl">120</span>,                             <span class="co"># Sample size from CPUE</span></span>
<span>  variance_components <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>               <span class="co"># Breakdown</span></span>
<span>    var_from_effort <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>    var_from_cpue <span class="op">=</span> <span class="fl">500</span>,</span>
<span>    var_from_covariance <span class="op">=</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span>,</span>
<span>  warnings <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span>,                    <span class="co"># Any warnings generated</span></span>
<span>  target_species_filter <span class="op">=</span> <span class="cn">FALSE</span>,            <span class="co"># If filtered to target species</span></span>
<span>  target_species_value <span class="op">=</span> <span class="cn">NULL</span>               <span class="co"># Value used for filtering</span></span>
<span><span class="op">)</span></span></code></pre></div>
<hr></div>
<div class="section level2">
<h2 id="error-messages--warnings">Error Messages &amp; Warnings<a class="anchor" aria-label="anchor" href="#error-messages--warnings"></a></h2>
<div class="section level3">
<h3 id="errors-abort-execution">Errors (abort execution)<a class="anchor" aria-label="anchor" href="#errors-abort-execution"></a></h3>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Mismatched grouping variables</span></span>
<span><span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"x"</span> <span class="op">=</span> <span class="st">"Grouping variables don't match between effort and CPUE estimates."</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"effort_est groups: {.field {names(effort_est)}}"</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"cpue_est groups: {.field {names(cpue_est)}}"</span>,</span>
<span>  <span class="st">"!"</span> <span class="op">=</span> <span class="st">"Ensure 'by' parameter matches for both est_effort() and est_cpue()."</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Missing required columns</span></span>
<span><span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"x"</span> <span class="op">=</span> <span class="st">"Required columns missing from {.arg effort_est}."</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"Need: {.field estimate, se}"</span>,</span>
<span>  <span class="st">"!"</span> <span class="op">=</span> <span class="st">"Received: {.field {names(effort_est)}}"</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Invalid correlation value</span></span>
<span><span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_abort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"x"</span> <span class="op">=</span> <span class="st">"Correlation must be between -1 and 1."</span>,</span>
<span>  <span class="st">"!"</span> <span class="op">=</span> <span class="st">"Received: {.val {correlation}}"</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="warnings-continue-with-caution">Warnings (continue with caution)<a class="anchor" aria-label="anchor" href="#warnings-continue-with-caution"></a></h3>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Different methods used</span></span>
<span><span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_warn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"!"</span> <span class="op">=</span> <span class="st">"Effort and CPUE used different estimation methods."</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"Effort: {.field {effort_method}}"</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"CPUE: {.field {cpue_method}}"</span>,</span>
<span>  <span class="st">"&gt;"</span> <span class="op">=</span> <span class="st">"Ensure methods are compatible for your analysis."</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Large difference in sample sizes</span></span>
<span><span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_warn</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"!"</span> <span class="op">=</span> <span class="st">"Sample sizes differ substantially between effort and CPUE."</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"Effort n: {.val {effort_n}}"</span>,</span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"CPUE n: {.val {cpue_n}}"</span>,</span>
<span>  <span class="st">"&gt;"</span> <span class="op">=</span> <span class="st">"Consider whether estimates represent same population."</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Assuming independence</span></span>
<span><span class="fu">cli</span><span class="fu">::</span><span class="fu"><a href="https://cli.r-lib.org/reference/cli_abort.html" class="external-link">cli_inform</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"i"</span> <span class="op">=</span> <span class="st">"Assuming independence between effort and CPUE (conservative)."</span>,</span>
<span>  <span class="st">"&gt;"</span> <span class="op">=</span> <span class="st">"If correlated, provide correlation parameter for more accurate variance."</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests">Unit Tests<a class="anchor" aria-label="anchor" href="#unit-tests"></a></h3>
<p><strong>File:</strong> <code>tests/testthat/test-est-total-harvest.R</code></p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"product estimator multiplies correctly"</span>, <span class="op">{</span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">1000</span>, se <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">cpue</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, correlation <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">estimate</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"variance propagation uses delta method"</span>, <span class="op">{</span></span>
<span>  <span class="va">E</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span>  <span class="va">SE_E</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span>  <span class="va">C</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span>  <span class="va">SE_C</span> <span class="op">&lt;-</span> <span class="fl">0.2</span></span>
<span></span>
<span>  <span class="co"># Expected variance (independent)</span></span>
<span>  <span class="va">var_expected</span> <span class="op">&lt;-</span> <span class="va">E</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">SE_C</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">C</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">SE_E</span><span class="op">^</span><span class="fl">2</span></span>
<span>  <span class="va">se_expected</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">var_expected</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="va">E</span>, se <span class="op">=</span> <span class="va">SE_E</span><span class="op">)</span></span>
<span>  <span class="va">cpue</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="va">C</span>, se <span class="op">=</span> <span class="va">SE_C</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, correlation <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">se</span>, <span class="va">se_expected</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"correlation increases/decreases variance appropriately"</span>, <span class="op">{</span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">1000</span>, se <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="va">cpue</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Independent</span></span>
<span>  <span class="va">result_ind</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, correlation <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Positive correlation</span></span>
<span>  <span class="va">result_pos</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, correlation <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Negative correlation</span></span>
<span>  <span class="va">result_neg</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, correlation <span class="op">=</span> <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Positive correlation should increase variance</span></span>
<span>  <span class="fu">expect_gt</span><span class="op">(</span><span class="va">result_pos</span><span class="op">$</span><span class="va">se</span>, <span class="va">result_ind</span><span class="op">$</span><span class="va">se</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Negative correlation should decrease variance</span></span>
<span>  <span class="fu">expect_lt</span><span class="op">(</span><span class="va">result_neg</span><span class="op">$</span><span class="va">se</span>, <span class="va">result_ind</span><span class="op">$</span><span class="va">se</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"grouped estimates work correctly"</span>, <span class="op">{</span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bass"</span>, <span class="st">"pike"</span><span class="op">)</span>,</span>
<span>    estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">800</span><span class="op">)</span>,</span>
<span>    se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>    ci_low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">800</span>, <span class="fl">640</span><span class="op">)</span>,</span>
<span>    ci_high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1200</span>, <span class="fl">960</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"instantaneous"</span>,</span>
<span>    diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">cpue</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bass"</span>, <span class="st">"pike"</span><span class="op">)</span>,</span>
<span>    estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1.5</span><span class="op">)</span>,</span>
<span>    se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.15</span><span class="op">)</span>,</span>
<span>    ci_low <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.6</span>, <span class="fl">1.2</span><span class="op">)</span>,</span>
<span>    ci_high <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.4</span>, <span class="fl">1.8</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"ratio_of_means"</span>,</span>
<span>    diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span>, <span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, by <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">estimate</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">2000</span><span class="op">)</span>  <span class="co"># bass</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">estimate</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fl">1200</span><span class="op">)</span>  <span class="co"># pike</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"response types work correctly"</span>, <span class="op">{</span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">1000</span>, se <span class="op">=</span> <span class="fl">100</span>, n <span class="op">=</span> <span class="fl">50</span>, method <span class="op">=</span> <span class="st">"instantaneous"</span>,</span>
<span>                   ci_low <span class="op">=</span> <span class="fl">800</span>, ci_high <span class="op">=</span> <span class="fl">1200</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cpue_total</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">3</span>, se <span class="op">=</span> <span class="fl">0.3</span>, n <span class="op">=</span> <span class="fl">100</span>, method <span class="op">=</span> <span class="st">"ratio_of_means"</span>,</span>
<span>                       ci_low <span class="op">=</span> <span class="fl">2.4</span>, ci_high <span class="op">=</span> <span class="fl">3.6</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cpue_kept</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="fl">0.2</span>, n <span class="op">=</span> <span class="fl">100</span>, method <span class="op">=</span> <span class="st">"ratio_of_means"</span>,</span>
<span>                      ci_low <span class="op">=</span> <span class="fl">1.6</span>, ci_high <span class="op">=</span> <span class="fl">2.4</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cpue_released</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">1</span>, se <span class="op">=</span> <span class="fl">0.1</span>, n <span class="op">=</span> <span class="fl">100</span>, method <span class="op">=</span> <span class="st">"ratio_of_means"</span>,</span>
<span>                          ci_low <span class="op">=</span> <span class="fl">0.8</span>, ci_high <span class="op">=</span> <span class="fl">1.2</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">total</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue_total</span>, response <span class="op">=</span> <span class="st">"catch_total"</span><span class="op">)</span></span>
<span>  <span class="va">kept</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue_kept</span>, response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span>  <span class="va">released</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue_released</span>, response <span class="op">=</span> <span class="st">"catch_released"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Relationship should approximately hold</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">total</span><span class="op">$</span><span class="va">estimate</span>, <span class="va">kept</span><span class="op">$</span><span class="va">estimate</span> <span class="op">+</span> <span class="va">released</span><span class="op">$</span><span class="va">estimate</span>, tolerance <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"input validation catches errors"</span>, <span class="op">{</span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">1000</span>, se <span class="op">=</span> <span class="fl">100</span>, species <span class="op">=</span> <span class="st">"bass"</span>,</span>
<span>                   n <span class="op">=</span> <span class="fl">50</span>, method <span class="op">=</span> <span class="st">"instantaneous"</span>, ci_low <span class="op">=</span> <span class="fl">800</span>,</span>
<span>                   ci_high <span class="op">=</span> <span class="fl">1200</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cpue</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="fl">0.2</span>, location <span class="op">=</span> <span class="st">"lake"</span>,</span>
<span>                 n <span class="op">=</span> <span class="fl">100</span>, method <span class="op">=</span> <span class="st">"ratio_of_means"</span>, ci_low <span class="op">=</span> <span class="fl">1.6</span>,</span>
<span>                 ci_high <span class="op">=</span> <span class="fl">2.4</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Mismatched grouping variables</span></span>
<span>  <span class="fu">expect_error</span><span class="op">(</span></span>
<span>    <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"location"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"Grouping variables"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"zero values handled appropriately"</span>, <span class="op">{</span></span>
<span>  <span class="va">effort</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">0</span>, se <span class="op">=</span> <span class="fl">0</span>, n <span class="op">=</span> <span class="fl">50</span>, method <span class="op">=</span> <span class="st">"instantaneous"</span>,</span>
<span>                   ci_low <span class="op">=</span> <span class="fl">0</span>, ci_high <span class="op">=</span> <span class="fl">0</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cpue</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span>estimate <span class="op">=</span> <span class="fl">2</span>, se <span class="op">=</span> <span class="fl">0.2</span>, n <span class="op">=</span> <span class="fl">100</span>, method <span class="op">=</span> <span class="st">"ratio_of_means"</span>,</span>
<span>                 ci_low <span class="op">=</span> <span class="fl">1.6</span>, ci_high <span class="op">=</span> <span class="fl">2.4</span>, diagnostics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort</span>, <span class="va">cpue</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">estimate</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">se</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">test_that</span><span class="op">(</span><span class="st">"target species filtering works"</span>, <span class="op">{</span></span>
<span>  <span class="co"># This will test the target_species_only functionality once implemented</span></span>
<span>  <span class="fu">skip</span><span class="op">(</span><span class="st">"Target species filtering not yet implemented"</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="integration-tests">Integration Tests<a class="anchor" aria-label="anchor" href="#integration-tests"></a></h3>
<p>Test with real survey workflow: 1. Create survey design 2. Estimate effort from counts 3. Estimate CPUE from interviews 4. Calculate total harvest 5. Verify results are reasonable</p>
<hr></div>
</div>
<div class="section level2">
<h2 id="documentation-examples">Documentation Examples<a class="anchor" aria-label="anchor" href="#documentation-examples"></a></h2>
<div class="section level3">
<h3 id="example-1-basic-usage">Example 1: Basic Usage<a class="anchor" aria-label="anchor" href="#example-1-basic-usage"></a></h3>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chrischizinski/tidycreel" class="external-link">tidycreel</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Effort from counts</span></span>
<span><span class="va">svy_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/as_day_svydesign.html">as_day_svydesign</a></span><span class="op">(</span><span class="va">calendar</span>, day_id <span class="op">=</span> <span class="st">"date"</span>,</span>
<span>                             strata_vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"day_type"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">effort_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_effort.html">est_effort</a></span><span class="op">(</span><span class="va">svy_day</span>, <span class="va">counts</span>, method <span class="op">=</span> <span class="st">"instantaneous"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. CPUE from interviews</span></span>
<span><span class="va">svy_int</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span>ids <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, weights <span class="op">=</span> <span class="op">~</span><span class="fl">1</span>, data <span class="op">=</span> <span class="va">interviews</span><span class="op">)</span></span>
<span><span class="va">cpue_est</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3. Total harvest</span></span>
<span><span class="va">harvest</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_est</span>, response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">harvest</span><span class="op">)</span></span>
<span><span class="co">#   estimate    se ci_low ci_high    n method     diagnostics</span></span>
<span><span class="co">#       2000   250   1510    2490   NA product   &lt;list [1]&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-2-by-species-and-location">Example 2: By Species and Location<a class="anchor" aria-label="anchor" href="#example-2-by-species-and-location"></a></h3>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate by groups</span></span>
<span><span class="va">effort_by_loc</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_effort.html">est_effort</a></span><span class="op">(</span><span class="va">svy_day</span>, <span class="va">counts</span>, by <span class="op">=</span> <span class="st">"location"</span>,</span>
<span>                            method <span class="op">=</span> <span class="st">"instantaneous"</span><span class="op">)</span></span>
<span><span class="va">cpue_by_species</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location"</span>, <span class="st">"species"</span><span class="op">)</span>,</span>
<span>                             response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Total harvest by location and species</span></span>
<span><span class="va">harvest_detailed</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_by_loc</span>,</span>
<span>  <span class="va">cpue_by_species</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"location"</span>, <span class="st">"species"</span><span class="op">)</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_kept"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">harvest_detailed</span><span class="op">)</span></span>
<span><span class="co">#   location species estimate    se ci_low ci_high    n method diagnostics</span></span>
<span><span class="co">#   North    bass        1500   200   1108    1892   NA product &lt;list [1]&gt;</span></span>
<span><span class="co">#   North    pike         800   120    565    1035   NA product &lt;list [1]&gt;</span></span>
<span><span class="co">#   South    bass        2200   280   1651    2749   NA product &lt;list [1]&gt;</span></span>
<span><span class="co">#   South    pike        1100   150    806    1394   NA product &lt;list [1]&gt;</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-3-total-catch-accounting">Example 3: Total Catch Accounting<a class="anchor" aria-label="anchor" href="#example-3-total-catch-accounting"></a></h3>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate total catch, harvest, and releases</span></span>
<span><span class="va">cpue_total</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, response <span class="op">=</span> <span class="st">"catch_total"</span><span class="op">)</span></span>
<span><span class="va">cpue_kept</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span><span class="va">cpue_released</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/est_cpue.html">est_cpue</a></span><span class="op">(</span><span class="va">svy_int</span>, response <span class="op">=</span> <span class="st">"catch_released"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">catch_total</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_total</span>,</span>
<span>                                 response <span class="op">=</span> <span class="st">"catch_total"</span><span class="op">)</span></span>
<span><span class="va">catch_kept</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_kept</span>,</span>
<span>                                response <span class="op">=</span> <span class="st">"catch_kept"</span><span class="op">)</span></span>
<span><span class="va">catch_released</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span><span class="va">effort_est</span>, <span class="va">cpue_released</span>,</span>
<span>                                    response <span class="op">=</span> <span class="st">"catch_released"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Verify relationship</span></span>
<span><span class="va">summary_table</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="op">(</span></span>
<span>  metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Total Catch"</span>, <span class="st">"Harvest (Kept)"</span>, <span class="st">"Released"</span><span class="op">)</span>,</span>
<span>  estimate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">catch_total</span><span class="op">$</span><span class="va">estimate</span>, <span class="va">catch_kept</span><span class="op">$</span><span class="va">estimate</span>, <span class="va">catch_released</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span>,</span>
<span>  se <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">catch_total</span><span class="op">$</span><span class="va">se</span>, <span class="va">catch_kept</span><span class="op">$</span><span class="va">se</span>, <span class="va">catch_released</span><span class="op">$</span><span class="va">se</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">summary_table</span><span class="op">)</span></span>
<span><span class="co">#   metric          estimate    se</span></span>
<span><span class="co">#   Total Catch         5000   500</span></span>
<span><span class="co">#   Harvest (Kept)      3000   350</span></span>
<span><span class="co">#   Released            2000   300</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-4-target-species-caught-while-sought">Example 4: Target Species (Caught While Sought)<a class="anchor" aria-label="anchor" href="#example-4-target-species-caught-while-sought"></a></h3>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Future implementation</span></span>
<span><span class="va">harvest_bass_sought</span> <span class="op">&lt;-</span> <span class="fu">est_total_harvest</span><span class="op">(</span></span>
<span>  <span class="va">effort_est</span>,</span>
<span>  <span class="va">cpue_est</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"species"</span>,</span>
<span>  response <span class="op">=</span> <span class="st">"catch_kept"</span>,</span>
<span>  target_species_only <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  target_col <span class="op">=</span> <span class="st">"target_species"</span>,</span>
<span>  target_value <span class="op">=</span> <span class="st">"bass"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">harvest_bass_sought</span><span class="op">)</span></span>
<span><span class="co">#   species estimate    se ci_low ci_high    n method     diagnostics</span></span>
<span><span class="co">#   bass        1200   180    847    1553   NA product   &lt;list [1]&gt;</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="next-steps">Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a></h2>
<ol style="list-style-type: decimal"><li>✅ Design document complete</li>
<li>⬜ Implement core function (<code>est_total_harvest</code>)</li>
<li>⬜ Write unit tests</li>
<li>⬜ Integration testing with real data</li>
<li>⬜ Documentation and vignettes</li>
<li>⬜ Add target species variant</li>
<li>⬜ Peer review and validation</li>
</ol><hr></div>
<div class="section level2">
<h2 id="questions-for-discussion">Questions for Discussion<a class="anchor" aria-label="anchor" href="#questions-for-discussion"></a></h2>
<ol style="list-style-type: decimal"><li><p><strong>Correlation default:</strong> Should we default to <code>NULL</code> (independent), <code>"auto"</code>, or require user to specify?</p></li>
<li><p><strong>Target species:</strong> Separate function or integrated with parameters?</p></li>
<li><p><strong>Response types:</strong> Add <code>"catch_released"</code> or calculate as <code>catch_total - catch_kept</code>?</p></li>
<li><p><strong>Method options:</strong> Start with just “product” or also implement “separate_ratio”?</p></li>
<li><p><strong>Diagnostics:</strong> What additional information should be included?</p></li>
</ol><hr><p><strong>Author:</strong> Planning document generated by Claude Code <strong>Date:</strong> October 24, 2025 <strong>Status:</strong> Awaiting implementation</p>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Chizinski.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

