# scripts/repair_namespace.R
# Rebuild NAMESPACE exports from actual function defs in R/*.R, then re-run roxygen.

pkg_root <- "."
r_dir <- file.path(pkg_root, "R")
ns_path <- file.path(pkg_root, "NAMESPACE")

# 1) Discover function names actually defined in R/*.R
files <- list.files(r_dir, pattern = "\\.R$", full.names = TRUE)
src <- lapply(files, readLines)
get_fun_names <- function(lines) {
  # match names like: name <- function(  (skips S3 method signatures with "." in the name still ok)
  m <- regmatches(lines, regexec("^\\s*([A-Za-z][A-Za-z0-9._]*)\\s*<-\\s*function\\s*\\(", lines))
  nm <- vapply(m, function(x) if (length(x) > 1) x[2] else NA_character_, character(1))
  nm[!is.na(nm)]
}
defined <- unique(unlist(lapply(src, get_fun_names), use.names = FALSE))

# 2) Parse current NAMESPACE exports (if present)
cur_exports <- character()
if (file.exists(ns_path)) {
  ns_lines <- readLines(ns_path, warn = FALSE)
  exp_lines <- grep("^\\s*export\\(", ns_lines, value = TRUE)
  cur_exports <- sub("^\\s*export\\(([^)]*)\\)\\s*$", "\\1", exp_lines)
}

# 3) Keep only exports that are real functions
keep <- intersect(cur_exports, defined)

# 4) If keep is empty, assume we want to export all defined functions with @export tags will later limit it.
#    But to purge junk immediately, we write only the safe "keep" set (possibly empty) and then let roxygen repopulate.
ns_header <- c("## Generated by repair_namespace.R â€” will be overwritten by roxygen2",
               "exportPattern(\"^[^\\\\.]\\\") # temporary, roxygen will replace")
ns_body <- if (length(keep)) sprintf("export(%s)", keep) else character()

# 5) Write a minimal clean NAMESPACE (roxygen will replace on document())
writeLines(c(ns_header, ns_body), ns_path)
cat(sprintf("Wrote cleaned NAMESPACE with %d export() lines.\n", length(ns_body)))

# 6) Re-run roxygen to regenerate the authoritative NAMESPACE
if (!requireNamespace("devtools", quietly = TRUE)) stop("devtools not installed")
devtools::document(quiet = TRUE)
cat("Regenerated NAMESPACE via roxygen.\n")

# 7) Print final exports for sanity
ns_lines2 <- readLines(ns_path, warn = FALSE)
final <- sub("^\\s*export\\(([^)]*)\\)\\s*$", "\\1", grep("^\\s*export\\(", ns_lines2, value = TRUE))
final <- sort(unique(final))
cat("Final exports:\n")
if (length(final)) cat(paste(" -", final), sep = "\n") else cat(" (none)\n")
