---
title: "Getting Started with tidycreel"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with tidycreel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidycreel)
library(dplyr)
library(ggplot2)
library(lubridate)
```

## Introduction

The `tidycreel` package provides a survey-first framework for creel surveys. Designs are lean containers; estimation uses day-level survey designs (`svydesign`) built from the sampling calendar with `as_day_svydesign()`.

## Survey Design Types

`tidycreel` supports three main data components:

1. Interviews (access-point or roving) and count tables (instantaneous/progressive).
2. Sampling calendar (days, strata, target vs actual samples).
3. Estimators that operate with a day-PSU `svydesign` for variance.

## Loading Example Data

The package includes example datasets that we'll use throughout this vignette:

```{r load-data}
# Load example datasets
interviews <- readr::read_csv(
  system.file("extdata/toy_interviews.csv", package = "tidycreel")
)
counts <- readr::read_csv(
  system.file("extdata/toy_counts.csv", package = "tidycreel")
)
calendar <- readr::read_csv(
  system.file("extdata/toy_calendar.csv", package = "tidycreel")
)

# Preview the data
head(interviews)
head(counts)
head(calendar)
```

## Creating an Access-Point Survey Container

Access-point designs are used when interviews are conducted at fixed locations where anglers exit the fishery. This constructor validates and stores inputs for downstream estimation.

```{r access-design}
# Create access-point survey design
access_design <- design_access(
  interviews = interviews,
  calendar = calendar,
  strata_vars = c("date", "shift_block")
)

# Examine the design object
class(access_design)
names(access_design)
```

## Creating a Roving Survey Container

Roving designs are used when interviewers move between locations to conduct interviews. This constructor stores interview/count data and the calendar for downstream estimation.

```{r roving-design}
# Minimal counts table matching the validation schema
counts_rov <- tibble::tibble(
  count_id = c("C001","C002","C003"),
  date = as.Date(c("2025-08-20","2025-08-20","2025-08-21")),
  time = as.POSIXct(c("2025-08-20 09:00:00","2025-08-20 11:00:00","2025-08-21 10:00:00"), tz = "UTC"),
  location = c("A","B","A"),
  mode = c("boat","bank","boat"),
  anglers_count = c(10L, 12L, 8L),
  parties_count = c(5L, 6L, 4L),
  weather_code = c("clear","clear","overcast"),
  temperature = c(20, 22, 19),
  wind_speed = c(5, 6, 4),
  visibility = c("good","good","fair"),
  count_duration = c(60L, 60L, 60L)
)

# Create roving survey design
roving_design <- design_roving(
  interviews = interviews,
  counts = counts_rov,
  calendar = calendar,
  strata_vars = c("date", "shift_block", "location")
)

# Examine the design object
class(roving_design)
names(roving_design)
```

## Day-PSU Designs and Replicate Variance

Build a day-level survey design from the calendar and (optionally) convert to a replicate-weight design for robust SEs.

```{r replicate-weights}
svy_day <- as_day_svydesign(calendar, day_id = "date", strata_vars = c("day_type", "month"))

# Bootstrap replicate design with 50 reps (keep small in examples)
svy_rep <- survey::as.svrepdesign(svy_day, type = "bootstrap", replicates = 50, mse = TRUE)
class(svy_rep)
summary(stats::weights(svy_day))
```

## Estimating Effort (Survey-First)

Once you have a day-PSU design, estimate effort from counts using the survey-first estimators.

```{r estimate-effort}
# Example instantaneous counts (toy)
counts_inst <- tibble::tibble(
  date = as.Date(c("2024-01-01","2024-01-01","2024-01-02","2024-01-02")),
  location = c("A","B","A","B"),
  count = c(10,12,8,15),
  interval_minutes = 60,
  total_day_minutes = 600
)

est_effort(
  design = svy_day,
  counts = counts_inst,
  method = "instantaneous",
  by = c("location")
)
```

## Advanced Usage

### Custom Stratification

You can specify custom stratification variables based on your survey design:

```{r custom-stratification}
## Diagnostics: check structure before design creation
str(calendar)
str(interviews)
# Create design with custom stratification
custom_design <- design_access(
  interviews = interviews,
  calendar = calendar,
  strata_vars = c("date")
)

# Check stratification
str(custom_design$interviews)
dplyr::count(custom_design$interviews, date, shift_block)
```

### Handling Missing Data

The validation functions will catch missing required columns:

```{r validation}
# This will produce an error due to missing columns
tryCatch({
  bad_interviews <- interviews[, -1]  # Remove first column
  design_access(bad_interviews, calendar)
}, error = function(e) {
  message("Validation error: ", e$message)
})
```

## Next Steps

Now that you have lean survey containers and a day-PSU design, you can:

1. **Estimate effort and CPUE** with survey-first estimators and `svydesign`
2. **Calculate population totals** with appropriate variance estimates
3. **Perform hypothesis tests** comparing different groups or time periods
4. **Generate reports** with confidence intervals and uncertainty bounds

See the package documentation for more advanced features and estimation functions.

## References

- Pollock, K. H., Jones, C. M., & Brown, T. L. (1994). *Angler survey methods and their applications in fisheries management*. American Fisheries Society.
- Malvestuto, S. P. (1996). *Sampling the recreational creel*. In Murphy, B. R. & Willis, D. W. (Eds.), *Fisheries techniques* (2nd ed., pp. 591-623). American Fisheries Society.
