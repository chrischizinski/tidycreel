---
title: "Getting Started with tidycreel"
output:
  rmarkdown::html_vignette:
    pandoc_args: ["--syntax-highlighting=tango"]
    highlight: null
vignette: >
  %\VignetteIndexEntry{Getting Started with tidycreel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tidycreel)
library(survey)
library(dplyr)
library(ggplot2)
library(lubridate)
```

## Introduction

The `tidycreel` package provides a survey-first framework for creel surveys, built on the `survey` package. Estimation uses day-level survey designs (`svydesign`) created from the sampling calendar with `as_day_svydesign()`, and interview-level designs for CPUE and catch estimation.

## Survey Design Types

`tidycreel` supports three main data components:

1. Interviews (access-point or roving) and count tables (instantaneous/progressive).
2. Sampling calendar (days, strata, target vs actual samples).
3. Estimators that operate with a day-PSU `svydesign` for variance.

## Loading Example Data

The package includes example datasets that we'll use throughout this vignette:

```{r load-data}
# Load example datasets
interviews <- readr::read_csv(
  system.file("extdata/toy_interviews.csv", package = "tidycreel")
)
counts <- readr::read_csv(
  system.file("extdata/toy_counts.csv", package = "tidycreel")
)
calendar <- readr::read_csv(
  system.file("extdata/toy_calendar.csv", package = "tidycreel")
)

# Preview the data
head(interviews)
head(counts)
head(calendar)
```

## Creating Survey Designs

The survey-first approach uses the `survey` package directly. You create a day-level survey design from your sampling calendar using `as_day_svydesign()`.

```{r day-design}
# Create day-level survey design from calendar
svy_day <- as_day_svydesign(
  calendar,
  day_id = "date",
  strata_vars = c("day_type", "month")
)

# Examine the survey design
class(svy_day)
summary(stats::weights(svy_day))
```

## Interview-Level Survey Designs

For CPUE and catch estimation, you can create interview-level survey designs directly with the `survey` package:

```{r interview-design}
# Simple survey design from interviews (no stratification)
svy_interviews <- survey::svydesign(
  ids = ~1,
  weights = ~1,
  data = interviews
)

# Or with stratification if needed
# svy_interviews_strat <- survey::svydesign(
#   ids = ~1,
#   strata = ~location,
#   weights = ~1,
#   data = interviews
# )
```

## Replicate Variance (Optional)

You can convert day-level designs to replicate-weight designs for robust standard errors:

```{r replicate-weights}
# Bootstrap replicate design with 50 reps (keep small in examples)
svy_rep <- survey::as.svrepdesign(svy_day, type = "bootstrap", replicates = 50, mse = TRUE)
class(svy_rep)
```

## Estimating Effort (Survey-First)

Once you have a day-PSU design, estimate effort from counts using the survey-first estimators.

```{r estimate-effort}
# Example instantaneous counts (toy)
counts_inst <- tibble::tibble(
  date = as.Date(c("2024-01-01","2024-01-01","2024-01-02","2024-01-02")),
  location = c("A","B","A","B"),
  count = c(10,12,8,15),
  interval_minutes = 60,
  total_day_minutes = 600
)

est_effort(
  design = svy_day,
  counts = counts_inst,
  method = "instantaneous",
  by = c("location")
)
```

## Estimating CPUE and Catch (Survey-First)

CPUE is estimated design-based from interview data. Prefer the ratio-of-means
form for incomplete trips; use mean-of-ratios for complete trips.

```{r cpue-catch}
# CPUE/Catch use interview-level survey designs
# CPUE by species (ratio-of-means)
suppressWarnings({
  cpue_species <- est_cpue(svy_interviews, by = c("target_species"), response = "catch_total")
})
cpue_species

# CPUE (mean-of-ratios) â€” for complete trips
suppressWarnings({
  cpue_mor <- est_cpue(svy_interviews, by = c("target_species"), response = "catch_total", mode = "mean_of_ratios")
})
cpue_mor

# Harvest totals by species
suppressWarnings({
  harvest_species <- est_catch(svy_interviews, by = c("target_species"), response = "catch_kept")
})
harvest_species
```

## Advanced Usage

### Custom Stratification

You can specify custom stratification variables when creating survey designs:

```{r custom-stratification}
## Diagnostics: check structure before design creation
str(calendar)
str(interviews)

# Create day-level design with simpler stratification
svy_day_simple <- as_day_svydesign(
  calendar,
  day_id = "date",
  strata_vars = c("day_type")  # Single stratification variable
)

# Check stratification
summary(svy_day_simple)
table(calendar$day_type)
```

### Handling Missing Data

The validation functions will catch missing required columns:

```{r validation}
# This will produce an error due to missing columns
tryCatch({
  bad_calendar <- calendar[, -1]  # Remove first column
  as_day_svydesign(bad_calendar, day_id = "date", strata_vars = c("day_type"))
}, error = function(e) {
  message("Validation error: ", e$message)
})
```

## Next Steps

Now that you have survey designs from the `survey` package, you can:

1. **Estimate effort** from counts using day-level designs (`est_effort()`)
2. **Estimate CPUE and catch** from interviews using interview-level designs (`est_cpue()`, `est_catch()`)
3. **Use replicate designs** for robust variance estimation
4. **Perform hypothesis tests** comparing different groups or time periods
5. **Generate reports** with confidence intervals and uncertainty bounds

See the package vignettes for more advanced features:
- `vignette("effort-survey-first")` for detailed effort estimation
- `vignette("aerial")` for aerial survey methods
- `vignette("cpue-catch")` for CPUE and catch estimation (coming soon)

## References

- Pollock, K. H., Jones, C. M., & Brown, T. L. (1994). *Angler survey methods and their applications in fisheries management*. American Fisheries Society.
- Malvestuto, S. P. (1996). *Sampling the recreational creel*. In Murphy, B. R. & Willis, D. W. (Eds.), *Fisheries techniques* (2nd ed., pp. 591-623). American Fisheries Society.
