---
title: "CPUE and Catch Estimation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{CPUE and Catch Estimation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(tidycreel)
library(survey)
library(dplyr)
library(ggplot2)
```

## Introduction

This vignette demonstrates how to estimate Catch Per Unit Effort (CPUE)
and total catch/harvest using tidycreel's survey-first approach. All
estimators build on the `survey` package for proper design-based
inference.

## Key Concepts

### CPUE Estimation Modes

tidycreel provides two CPUE estimation modes:

1. **Ratio-of-means** (default): Total catch รท total effort
   - Preferred for incomplete trips or when trip completion varies
   - Uses `survey::svyratio()` for proper variance
   - More robust to outliers

2. **Mean-of-ratios**: Mean of (catch รท effort) per angler
   - Appropriate for complete trips only
   - Uses `survey::svymean()` on pre-computed ratios
   - Can be sensitive to zero-effort trips

### Catch/Harvest Estimation

Total catch or harvest uses `survey::svytotal()` to expand interview
data to population totals with proper variance estimation.

## Loading Example Data

```{r load-data}
# Load toy datasets
interviews <- readr::read_csv(
  system.file("extdata/toy_interviews.csv", package = "tidycreel"),
  show_col_types = FALSE
)
calendar <- readr::read_csv(
  system.file("extdata/toy_calendar.csv", package = "tidycreel"),
  show_col_types = FALSE
)

# Preview interview data
head(interviews)
```

## Creating Survey Designs

### Day-Level Design

First, create a day-level design from the sampling calendar:

```{r day-design}
# Create day-level survey design
svy_day <- as_day_svydesign(
  calendar,
  day_id = "date",
  strata_vars = c("day_type", "month")
)

# Check the design
summary(weights(svy_day))
```

### Interview-Level Design

For CPUE and catch estimation, we need an interview-level design. Join
day-level weights to interviews:

```{r interview-design}
# Join day weights to interviews
interviews_weighted <- interviews %>%
  left_join(
    svy_day$variables %>% select(date, .w),
    by = "date"
  )

# Create interview-level survey design
svy_interview <- survey::svydesign(
  ids = ~1,
  weights = ~.w,
  data = interviews_weighted
)

# Check the design
summary(weights(svy_interview))
```

## CPUE Estimation

### Ratio-of-Means (Default)

The ratio-of-means approach is preferred for most creel surveys:

```{r cpue-ratio-means}
# CPUE by target species (ratio-of-means)
cpue_species <- est_cpue(
  svy_interview,
  by = c("target_species"),
  response = "catch_total",
  effort = "hours_fished",
  mode = "ratio_of_means"
)

cpue_species
```

This estimates CPUE as:

$$\text{CPUE} = \frac{\sum w_i \cdot \text{catch}_i}{\sum w_i \cdot
\text{effort}_i}$$

where $w_i$ are the survey weights.

### Mean-of-Ratios

For complete trips, you can use mean-of-ratios:

```{r cpue-mean-ratios}
# Filter to complete trips only
complete_trips <- interviews_weighted %>%
  filter(trip_complete == TRUE)

svy_complete <- survey::svydesign(
  ids = ~1,
  weights = ~.w,
  data = complete_trips
)

# CPUE by species (mean-of-ratios)
cpue_mor <- est_cpue(
  svy_complete,
  by = c("target_species"),
  response = "catch_total",
  effort = "hours_fished",
  mode = "mean_of_ratios"
)

cpue_mor
```

This estimates CPUE as:

$$\text{CPUE} = \frac{1}{n}\sum w_i \cdot
\frac{\text{catch}_i}{\text{effort}_i}$$

### Comparing Methods

```{r compare-cpue}
# Compare the two methods
comparison <- bind_rows(
  cpue_species %>% mutate(method = "ratio_of_means"),
  cpue_mor %>% mutate(method = "mean_of_ratios")
) %>%
  select(target_species, method, estimate, se, ci_low, ci_high)

comparison
```

### CPUE by Multiple Groups

You can stratify CPUE by multiple variables:

```{r cpue-groups}
# CPUE by species and mode
cpue_mode <- est_cpue(
  svy_interview,
  by = c("target_species", "mode"),
  response = "catch_total",
  effort = "hours_fished",
  mode = "ratio_of_means"
)

cpue_mode
```

## Catch and Harvest Estimation

### Total Catch

Estimate total catch using `est_catch()`:

```{r catch-total}
# Total catch by species
catch_species <- est_catch(
  svy_interview,
  by = c("target_species"),
  response = "catch_total"
)

catch_species
```

### Harvest (Kept Fish)

Estimate harvest (kept fish) separately:

```{r harvest}
# Harvest by species
harvest_species <- est_catch(
  svy_interview,
  by = c("target_species"),
  response = "catch_kept"
)

harvest_species
```

### Released Fish

Calculate released fish:

```{r released}
# Released fish by species
released_species <- est_catch(
  svy_interview,
  by = c("target_species"),
  response = "catch_released"
)

released_species
```

### Catch by Multiple Groups

```{r catch-groups}
# Catch by species and location
catch_location <- est_catch(
  svy_interview,
  by = c("target_species", "location"),
  response = "catch_total"
)

catch_location
```

## Visualization

### CPUE by Species

```{r plot-cpue, fig.width=7, fig.height=4}
# Plot CPUE with confidence intervals
ggplot(cpue_species, aes(x = target_species, y = estimate)) +
  geom_col(fill = "steelblue", alpha = 0.7) +
  geom_errorbar(
    aes(ymin = ci_low, ymax = ci_high),
    width = 0.2
  ) +
  labs(
    title = "CPUE by Target Species",
    x = "Target Species",
    y = "CPUE (fish per hour)",
    caption = "Error bars show 95% confidence intervals"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Catch vs Harvest

```{r plot-catch-harvest, fig.width=7, fig.height=4}
# Combine catch and harvest for comparison
catch_harvest <- bind_rows(
  catch_species %>% mutate(type = "Total Catch"),
  harvest_species %>% mutate(type = "Harvest (Kept)")
)

ggplot(catch_harvest, aes(x = target_species, y = estimate, fill = type)) +
  geom_col(position = "dodge", alpha = 0.7) +
  geom_errorbar(
    aes(ymin = ci_low, ymax = ci_high),
    position = position_dodge(width = 0.9),
    width = 0.2
  ) +
  labs(
    title = "Total Catch vs Harvest by Species",
    x = "Target Species",
    y = "Number of Fish",
    fill = "Type",
    caption = "Error bars show 95% confidence intervals"
  ) +
  scale_fill_manual(values = c("steelblue", "coral")) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## Advanced: Replicate Designs

For robust variance estimation, use replicate weights:

```{r replicate-design}
# Convert to bootstrap replicate design
svy_rep <- survey::as.svrepdesign(
  svy_day,
  type = "bootstrap",
  replicates = 50,
  mse = TRUE
)

# Join replicate weights to interviews
interviews_rep <- interviews %>%
  left_join(
    svy_rep$variables %>% select(date, starts_with(".w")),
    by = "date"
  )

# Create replicate interview design
svy_interview_rep <- survey::svrepdesign(
  weights = ~.w,
  repweights = interviews_rep %>%
    select(starts_with(".w")) %>%
    select(-.w),
  type = "bootstrap",
  data = interviews_rep,
  mse = TRUE
)

# Estimate CPUE with replicate design
cpue_rep <- est_cpue(
  svy_interview_rep,
  by = c("target_species"),
  response = "catch_total",
  effort = "hours_fished",
  mode = "ratio_of_means"
)

cpue_rep
```

## Best Practices

1. **Use ratio-of-means** for CPUE unless all trips are complete
2. **Check for zero-effort trips** before using mean-of-ratios
3. **Use replicate designs** for complex variance structures
4. **Stratify appropriately** using the `by` parameter
5. **Document assumptions** about trip completion and effort measurement
6. **Visualize uncertainty** using confidence intervals

## Statistical Notes

### Ratio-of-Means Variance

The ratio-of-means estimator uses the delta method via
`survey::svyratio()`:

$$\text{Var}(\hat{R}) \approx \frac{1}{\bar{X}^2}\left[\text{Var}(\bar{Y})
+ R^2\text{Var}(\bar{X}) - 2R\text{Cov}(\bar{Y},\bar{X})\right]$$

where $R = \bar{Y}/\bar{X}$ is the ratio, $\bar{Y}$ is mean catch, and
$\bar{X}$ is mean effort.

### Mean-of-Ratios Variance

The mean-of-ratios estimator treats each ratio as an observation:

$$\text{Var}(\bar{R}) = \frac{1}{n}\text{Var}(R_i)$$

This can be unstable when effort varies widely or includes zeros.

## References

- Lumley, T. (2004). *Analysis of complex survey samples*. Journal of
  Statistical Software, 9(1), 1-19.
- Pollock, K. H., Jones, C. M., & Brown, T. L. (1994). *Angler survey
  methods and their applications in fisheries management*. American
  Fisheries Society.
- Cochran, W. G. (1977). *Sampling techniques* (3rd ed.). Wiley.

## See Also

- `vignette("getting-started")` - Introduction to tidycreel
- `vignette("effort_survey_first")` - Effort estimation
- `?est_cpue` - CPUE estimation function documentation
- `?est_catch` - Catch estimation function documentation
