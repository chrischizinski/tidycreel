% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/aggregate-cpue.R
\name{aggregate_cpue}
\alias{aggregate_cpue}
\title{Aggregate CPUE Across Species Using Survey Design}
\usage{
aggregate_cpue(
  cpue_data,
  svy_design,
  species_col = "species",
  species_values,
  group_name,
  by = NULL,
  response = c("catch_total", "catch_kept", "catch_released"),
  effort_col = "hours_fished",
  mode = "ratio_of_means",
  conf_level = 0.95
)
}
\arguments{
\item{cpue_data}{Interview data (raw, before estimation) containing catch by species}

\item{svy_design}{Survey design object (\code{svydesign} or \code{svrepdesign}) built on \code{cpue_data}}

\item{species_col}{Column name containing species identifier}

\item{species_values}{Character vector of species to aggregate}

\item{group_name}{Name for the aggregated group (e.g., "black_bass", "panfish")}

\item{by}{Additional grouping variables (e.g., \code{c("location", "date")})}

\item{response}{Type of catch: \code{"catch_total"}, \code{"catch_kept"}, or \code{"catch_released"}}

\item{effort_col}{Effort column for denominator (default \code{"hours_fished"})}

\item{mode}{Estimation mode: \code{"auto"}, \code{"ratio_of_means"}, or \code{"mean_of_ratios"}.
Defaults to \code{"ratio_of_means"} for robustness.}

\item{conf_level}{Confidence level for Wald CIs (default 0.95)}
}
\value{
Tibble with grouping columns (including \code{species_group}), \code{estimate},
\code{se}, \code{ci_low}, \code{ci_high}, \code{n}, \code{method}, and \code{diagnostics} list-column.
Schema matches \code{est_cpue()} output for seamless use with \code{est_total_harvest()}.
}
\description{
Combines CPUE estimates for multiple species into a single aggregate,
properly accounting for survey design and covariance between species.
This function is essential for calculating total harvest for species groups
(e.g., black bass, panfish, catfish) while maintaining proper variance estimation.
}
\details{
\strong{Statistical Approach:}

This function performs survey-design-based aggregation, which is CRITICAL for
proper variance estimation. It works by:
\enumerate{
\item Creating an aggregated catch variable by summing catch across specified species
within each interview
\item Updating the survey design with this aggregated variable
\item Estimating CPUE for the aggregate using standard survey methods
\item Properly accounting for covariance between species
}

\strong{Why This Matters:}

Simply adding species-specific harvest estimates (effort Ã— CPUE for each species)
and summing them produces INCORRECT variance estimates because it ignores
the covariance between species catches. This function ensures proper variance
by aggregating at the CPUE level before multiplying by effort.

\strong{WRONG Approach:}

\if{html}{\out{<div class="sourceCode r">}}\preformatted{# DON'T DO THIS - ignores covariance
harvest_lmb <- est_total_harvest(effort, cpue_largemouth)
harvest_smb <- est_total_harvest(effort, cpue_smallmouth)
harvest_bass_wrong <- harvest_lmb$estimate + harvest_smb$estimate
}\if{html}{\out{</div>}}

\strong{CORRECT Approach:}

\if{html}{\out{<div class="sourceCode r">}}\preformatted{# DO THIS - proper survey-based aggregation
cpue_black_bass <- aggregate_cpue(
  interviews, svy_int,
  species_values = c("largemouth_bass", "smallmouth_bass"),
  group_name = "black_bass"
)
harvest_bass_correct <- est_total_harvest(effort, cpue_black_bass)
}\if{html}{\out{</div>}}

\strong{Missing Species Handling:}

If \code{species_values} includes species not present in the data, they are
silently ignored (contributing zero to the aggregate). A warning is issued
if ALL specified species are missing.
}
\examples{
\dontrun{
library(tidycreel)
library(survey)

# Example: Aggregate black bass species
svy_int <- svydesign(ids = ~1, weights = ~1, data = interviews)

cpue_black_bass <- aggregate_cpue(
  cpue_data = interviews,
  svy_design = svy_int,
  species_col = "species",
  species_values = c("largemouth_bass", "smallmouth_bass", "spotted_bass"),
  group_name = "black_bass",
  response = "catch_kept"
)

# Use in harvest calculation
harvest_black_bass <- est_total_harvest(effort_est, cpue_black_bass)

# Aggregate by location and species group
cpue_panfish_by_loc <- aggregate_cpue(
  cpue_data = interviews,
  svy_design = svy_int,
  species_values = c("bluegill", "redear_sunfish", "green_sunfish"),
  group_name = "panfish",
  by = "location",
  response = "catch_kept"
)

# All species combined
cpue_all_species <- aggregate_cpue(
  cpue_data = interviews,
  svy_design = svy_int,
  species_values = unique(interviews$species),
  group_name = "all_species",
  response = "catch_total"
)
}

}
\references{
Pollock, K.H., C.M. Jones, and T.L. Brown. 1994. Angler Survey Methods
and Their Applications in Fisheries Management. American Fisheries
Society Special Publication 25.
}
\seealso{
\code{\link[=est_cpue]{est_cpue()}}, \code{\link[=est_total_harvest]{est_total_harvest()}}
}
